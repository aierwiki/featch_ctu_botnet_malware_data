import scrapy
import re

class QuotesSpider(scrapy.Spider):
    name = "ctubot"
    start_urls = [
        'https://www.stratosphereips.org/datasets-malware',
    ]
    
    def parse(self, response):
        bots = response.css('div.sqs-block-content p')
        for bot in bots:
            url = bot.css('a::attr(href)').get()
            if url is None:
                continue
            if re.search(r'.*publicDatasets.*', url) is None:
                continue
            botname = bot.css('a::text').get()
            md5 = bot.css('p::text').get()
            
            request = scrapy.Request(url, 
                             callback = self.parse_page2,
                             cb_kwargs = dict(botname=botname, md5=md5))
            yield request
    
    def parse_page2(self, response, botname, md5):
        for file in response.css('tr td'):
            file_name = file.css('a::text').get()
            if file_name is None or re.search(r'^.*\.pcap$', file_name) is None:
                continue
            link = file.css('a::attr(href)').get()
            link = response.urljoin(link)
            yield {
                'botname':botname,
                'md5':md5,
                'file_name':file_name,
                'link':link
            }